import os
import pandas as pd
from datetime import datetime

def validate_excel(src_file, dest_file, rule_file, test_data, result_folder="results"):
    os.makedirs(result_folder, exist_ok=True)

    # load files
    src_df = pd.read_excel(src_file)                      # one source sheet
    dest_df = pd.read_excel(dest_file, sheet_name=None)   # all destination sheets
    rules = pd.read_excel(rule_file)                      # 3 cols

    results = []

    for test_name in test_data.get("tests", []):
        # find row in source
        row = src_df[src_df["TestName"] == test_name]
        if row.empty:
            results.append({"test": test_name, "status": "Not in source"})
            continue

        for _, r in rules.iterrows():
            src_col, dest_col, dest_sheet = r["src_col"], r["dest_col"], r["dest_sheet"]

            if src_col not in src_df.columns:
                results.append({"test": test_name, "src_val": None,
                                "dest_sheet": dest_sheet, "dest_col": dest_col,
                                "status": "Src col missing"})
                continue

            src_val = row[src_col].iloc[0]

            if dest_sheet not in dest_df:
                results.append({"test": test_name, "src_val": src_val,
                                "dest_sheet": dest_sheet, "dest_col": dest_col,
                                "status": "Dest sheet missing"})
                continue

            dest_data = dest_df[dest_sheet]

            if dest_col not in dest_data.columns:
                results.append({"test": test_name, "src_val": src_val,
                                "dest_sheet": dest_sheet, "dest_col": dest_col,
                                "status": "Dest col missing"})
                continue

            # simple existence check
            if src_val in dest_data[dest_col].values:
                status, dest_val = "Pass", src_val
            else:
                status, dest_val = "Fail", None

            results.append({"test": test_name, "src_val": src_val,
                            "dest_sheet": dest_sheet, "dest_col": dest_col,
                            "dest_val": dest_val, "status": status})

    # save results
    df = pd.DataFrame(results)
    today = datetime.now().strftime("%Y%m%d")
    result_file = os.path.join(result_folder, f"validation_results_{today}.xlsx")
    df.to_excel(result_file, index=False)

    print(f"âœ… Results saved: {result_file}")