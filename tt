import pandas as pd

# === File paths ===
source_file = "source.xlsx"
dest_file = "destination.xlsx"
rules_file = "rules.txt"
output_file = "output.xlsx"

# === Load Excel files ===
src_df = pd.read_excel(source_file, sheet_name=0)
dest_xls = pd.ExcelFile(dest_file)

# === Read the validation rules ===
with open(rules_file, "r") as f:
    lines = [line.strip() for line in f if line.strip()]

# === Store results ===
results = []

for rule in lines:
    try:
        sheet_col = rule.split(".")
        if len(sheet_col) != 2:
            continue  # Skip invalid lines

        sheet, col = sheet_col[0].strip(), sheet_col[1].strip()

        if "sht1" in sheet:
            src_values = src_df[col] if col in src_df.columns else None
        else:
            continue  # Skip for now if source doesn't have this

        dest_sheet = sheet.replace("sht2", "")  # Get actual sheet name like "" or "2"
        dest_sheet_name = f"Sheet{dest_sheet or 1}"  # fallback Sheet1

        if dest_sheet_name not in dest_xls.sheet_names:
            print(f"Sheet '{dest_sheet_name}' not found.")
            continue

        dest_df = pd.read_excel(dest_file, sheet_name=dest_sheet_name)
        if col not in dest_df.columns:
            print(f"Column '{col}' not found in sheet '{dest_sheet_name}'")
            continue

        # Compare row-by-row
        for i in range(min(len(src_df), len(dest_df))):
            src_val = src_df.at[i, col] if col in src_df.columns else None
            dest_val = dest_df.at[i, col] if col in dest_df.columns else None
            status = "Pass" if str(src_val).strip() == str(dest_val).strip() else "Fail"
            results.append({
                "Row": i + 2,
                "Column": col,
                "Source Value": src_val,
                "Dest Value": dest_val,
                "Status": status
            })

    except Exception as e:
        print(f"Error processing rule '{rule}': {e}")

# === Save results to Excel ===
output_df = pd.DataFrame(results)
output_df.to_excel(output_file, index=False)
print(f"Validation complete. Output saved to {output_file}")