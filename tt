import pandas as pd

# File paths (update if needed)
source_file = "source.xlsx"
dest_file = "dest.xls"
rule_file = "rule.xlsx"
output_file = "validation_result.xlsx"

# Read rule file
rule_df = pd.read_excel(rule_file)

# Read source file (all sheets)
source_sheets = pd.read_excel(source_file, sheet_name=None)

# Read destination file (.xls format) using xlrd engine
dest_sheets = pd.read_excel(dest_file, sheet_name=None, engine='xlrd')

# Ensure rule column names are lowercase to match code
rule_df.columns = [col.lower() for col in rule_df.columns]

# Validation logic
validation_results = []

for _, rule in rule_df.iterrows():
    dest_sheet = rule['sheetname']
    dest_column = rule['columnname']
    src_column = rule['mapper']

    for src_sheet_name, src_df in source_sheets.items():
        if src_column not in src_df.columns:
            continue
        for value in src_df[src_column].dropna().unique():
            if dest_sheet in dest_sheets and dest_column in dest_sheets[dest_sheet].columns:
                match_found = value in dest_sheets[dest_sheet][dest_column].values
            else:
                match_found = False
            validation_results.append({
                'SheetName': dest_sheet,
                'ColumnName': dest_column,
                'Value': value,
                'MatchFound': match_found,
                'SrcSheetName': src_sheet_name
            })

# Create and export result
result_df = pd.DataFrame(validation_results)
result_df.to_excel(output_file, index=False)

print(f"Validation complete. Results saved to: {output_file}")
