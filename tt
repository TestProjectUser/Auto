import pandas as pd

# Load rules
rules_df = pd.read_excel("rules.xlsx", sheet_name="kyc")
rules_map = dict(zip(rules_df["Question"], rules_df["SrcColumn"]))

# Load source data
src_df = pd.read_excel("src.xlsx")

# Load destination data (.xls may need xlrd engine)
dest_df = pd.read_excel("dest.xls")

results = []

for cust_id in src_df["CustID"].unique():
    src_row = src_df[src_df["CustID"] == cust_id].iloc[0]

    dest_rows = dest_df[dest_df["CustID"] == cust_id]

    for _, dest_row in dest_rows.iterrows():
        question = dest_row["Question"]

        if question in rules_map:  # check if this question is to be validated
            src_col = rules_map[question]
            src_value = str(src_row[src_col]).strip()
            dest_value = str(dest_row["Answer"]).strip() if pd.notna(dest_row["Answer"]) else str(dest_row["Answer1"]).strip()

            status = "PASS" if src_value == dest_value else "FAIL"

            results.append({
                "CustID": cust_id,
                "Question": question,
                "SrcValue": src_value,
                "DestValue": dest_value,
                "Status": status
            })

# Convert to DataFrame and save output
results_df = pd.DataFrame(results)
results_df.to_excel("validation_output.xlsx", index=False)